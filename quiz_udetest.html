<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Ç¶„ÉáË©¶„Åó„É¢„Éº„Éâ</title>

  <style>
    body {
      font-family: sans-serif;
      background:#f5f5f5;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      margin:0;
    }

    .container {
      background:white;
      padding:2rem;
      border-radius:12px;
      width:90%;
      max-width:420px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }

    .option {
      width:100%;
      padding:1rem;
      margin-bottom:1rem;
      background:#28a745;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
      text-align:left;
    }

    /* Ê≠£Ëß£ÔºùËµ§ */
    .correct { background:#dc3545 !important; }

    /* ‰∏çÊ≠£Ëß£ÔºùÈùíÔºàÊ≠£Ëß£„Å†„ÅëÈùíÔºâ */
    .wrong { background:#0275d8 !important; }

    #nextBtn {
      width:100%;
      padding:1rem;
      background:#6c757d;
      color:white;
      border:none;
      border-radius:6px;
      display:none;
      cursor:pointer;
      margin-top:1rem;
    }

    .correctText {
      color:#dc3545;
      font-weight:bold;
      margin-bottom:0.5rem;
    }

    .wrongText {
      color:#0275d8;
      font-weight:bold;
      margin-bottom:0.5rem;
    }

    #explanation {
      display:none;
      background:#eee;
      padding:1rem;
      border-radius:6px;
      margin-top:0.5rem;
    }

    .lightgray-btn {
      background:#dcdcdc;
      color:#333;
      border:none;
      border-radius:6px;
      padding:1rem;
      width:100%;
      margin-top:1rem;
      cursor:pointer;
    }
    .lightgray-btn:hover {
      background:#cfcfcf;
    }
  </style>
</head>

<body>

<div class="container" id="quizScreen">
  <p id="progress"></p>
  <h2 id="questionText"></h2>

  <div id="options"></div>

  <div id="judgeText" style="display:none;"></div>

  <div id="explanation"></div>

  <button id="nextBtn" onclick="nextQuestion()">Ê¨°„ÅÆÂïèÈ°å„Å∏</button>
</div>

<div class="container" id="resultScreen" style="display:none;">
  <h2 style="text-align:center;">ÁµêÊûú</h2>
  <p id="scoreText"></p>

  <button class="lightgray-btn" onclick="location.href='udetest.html'">
    „Ç¶„ÉáË©¶„Åó„Å´Êàª„Çã
  </button>

  <button class="lightgray-btn" onclick="location.href='mode.html'">
    „Éà„ÉÉ„Éó„Å´Êàª„Çã
  </button>
</div>

<script>
  let quizData = [];
  let questions = [];
  let index = 0;
  let correct = 0;

  const subject = localStorage.getItem("udetest_subject");
  const chapters = JSON.parse(localStorage.getItem("udetest_chapters"));

  /* „Ç≠„É£„É©ÁîªÂÉè„Éó„É™„É≠„Éº„Éâ */
  const perfectImages = [
    "ushiro_harimijikai_gray_ikume_.png",
    "01harimijikai_grau_ikume.png",
    "Èô∏‰∏ä„Ç§„ÇØ„É°„Å°„ÇÉ„Çì.png",
    "Â∏ΩÂ≠ê„Å™„ÅóÈáéÁêÉ„É¶„Éã„Éï„Ç©„Éº„É†.png"
  ];

  const preloadedImages = [];
  perfectImages.forEach(src => {
    const img = new Image();
    img.src = src;
    preloadedImages.push(img);
  });

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  fetch("quizzes.json")
    .then(res=>res.json())
    .then(data=>{
      quizData = data;

      let pool = quizData.filter(q =>
        q.subject === subject && chapters.includes(q.chapter)
      );

      shuffle(pool);

      /* üî• „Åì„Åì„Åå‰ªäÂõû„ÅÆÈáçË¶Å„Éù„Ç§„É≥„ÉàÔºö„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„ÅÆÂïèÈ°åÊï∞„ÇíÂèñÂæó */
      const count = Number(localStorage.getItem("udetest_count")) || 15;

      questions = pool.slice(0, count);

      showQuestion();
    });

  function showQuestion() {
    const q = questions[index];

    document.getElementById("progress").textContent =
      `Á¨¨${index+1}Âïè / ÂÖ®${questions.length}Âïè`;

    document.getElementById("questionText").textContent = q.question;

    document.getElementById("judgeText").style.display = "none";

    const optDiv = document.getElementById("options");
    optDiv.innerHTML = "";

    q.options.forEach((opt,i)=>{
      const btn=document.createElement("button");
      btn.className="option";
      btn.textContent=opt;
      btn.onclick=()=>checkAnswer(i);
      optDiv.appendChild(btn);
    });

    document.getElementById("explanation").style.display="none";
    document.getElementById("nextBtn").style.display="none";
  }

  /* Ê≠£Ëß£ÔºùËµ§„ÄÅ‰∏çÊ≠£Ëß£ÔºùÈùíÔºàÊ≠£Ëß£„Å†„ÅëÈùíÔºâ */
  function checkAnswer(i){
    const q = questions[index];
    const btns = document.querySelectorAll(".option");

    btns.forEach(btn => btn.disabled = true);

    const judge = document.getElementById("judgeText");

    if(i === q.correctIndex){
      correct++;
      btns[q.correctIndex].classList.add("correct");
      judge.textContent = "Ê≠£Ëß£ÔºÅ";
      judge.className = "correctText";
    } else {
      btns[q.correctIndex].classList.add("wrong");
      judge.textContent = "‰∏çÊ≠£Ëß£‚Ä¶";
      judge.className = "wrongText";
    }

    judge.style.display = "block";

    const exp=document.getElementById("explanation");
    exp.innerHTML=q.explanation;
    exp.style.display="block";

    document.getElementById("nextBtn").style.display="block";
  }

  function nextQuestion(){
    index++;
    if(index>=questions.length){
      showResult();
      return;
    }
    showQuestion();
  }

  function showResult(){
    document.getElementById("quizScreen").style.display="none";
    const resultScreen = document.getElementById("resultScreen");
    resultScreen.style.display="block";

    const rate = Math.round((correct/questions.length)*100);
    document.getElementById("scoreText").textContent =
      `Ê≠£Ëß£Êï∞Ôºö${correct} / ${questions.length}ÔºàÊ≠£Á≠îÁéáÔºö${rate}%Ôºâ`;

    const oldImg = document.getElementById("perfectImg");
    if (oldImg) oldImg.remove();

    const oldMsg = document.getElementById("perfectMsg");
    if (oldMsg) oldMsg.remove();

    resultScreen.style.background = "white";

    if(rate === 100){

      resultScreen.style.background = "#fff8d6";

      const randomImg = perfectImages[Math.floor(Math.random() * perfectImages.length)];

      const img = document.createElement("img");
      img.id = "perfectImg";
      img.src = randomImg;
      img.style.width = "100%";
      img.style.maxWidth = "130px";
      img.style.display = "block";
      img.style.margin = "0 auto 1rem auto";
      resultScreen.insertBefore(img, resultScreen.firstChild);

      const msg = document.createElement("div");
      msg.id = "perfectMsg";
      msg.textContent = "Very Good!";
      msg.style.textAlign = "center";
      msg.style.fontSize = "1.4rem";
      msg.style.fontWeight = "bold";
      msg.style.color = "#d9534f";
      msg.style.marginBottom = "1rem";
      resultScreen.insertBefore(msg, document.getElementById("scoreText"));
    }
  }
</script>

</body>
</html>
