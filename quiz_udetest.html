<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ウデ試しモード</title>

  <style>
    body {
      font-family: sans-serif;
      background:#f5f5f5;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      margin:0;
    }

    .container {
      background:white;
      padding:2rem;
      border-radius:12px;
      width:90%;
      max-width:420px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }

    .option {
      width:100%;
      padding:1rem;
      margin-bottom:1rem;
      background:#28a745;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
      text-align:left;
    }

    .correct { background:#28a745 !important; }
    .wrong { background:#dc3545 !important; }

    #nextBtn {
      width:100%;
      padding:1rem;
      background:#6c757d;
      color:white;
      border:none;
      border-radius:6px;
      display:none;
      cursor:pointer;
      margin-top:1rem;
    }

    .correctText {
      color:#d9534f;
      font-weight:bold;
      margin-bottom:0.5rem;
    }

    .wrongText {
      color:#0275d8;
      font-weight:bold;
      margin-bottom:0.5rem;
    }

    #explanation {
      display:none;
      background:#eee;
      padding:1rem;
      border-radius:6px;
      margin-top:0.5rem;
    }

    /* ✅ 自然な薄いグレーボタン */
    .lightgray-btn {
      background:#dcdcdc;
      color:#333;
      border:none;
      border-radius:6px;
      padding:1rem;
      width:100%;
      margin-top:1rem;
      cursor:pointer;
    }
    .lightgray-btn:hover {
      background:#cfcfcf;
    }
  </style>
</head>

<body>

<div class="container" id="quizScreen">
  <p id="progress"></p>
  <h2 id="questionText"></h2>

  <div id="options"></div>

  <div id="judgeText" style="display:none;"></div>

  <div id="explanation"></div>

  <button id="nextBtn" onclick="nextQuestion()">次の問題へ</button>
</div>

<div class="container" id="resultScreen" style="display:none;">
  <h2>結果</h2>
  <p id="scoreText"></p>

  <button class="lightgray-btn" onclick="location.href='udetest.html'">
    ウデ試しに戻る
  </button>

  <button class="lightgray-btn" onclick="location.href='mode.html'">
    トップに戻る
  </button>
</div>

<script>
  let quizData = [];
  let questions = [];
  let index = 0;
  let correct = 0;

  const subject = localStorage.getItem("udetest_subject");
  const chapters = JSON.parse(localStorage.getItem("udetest_chapters"));

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  fetch("quizzes.json")
    .then(res=>res.json())
    .then(data=>{
      quizData = data;

      let pool = quizData.filter(q =>
        q.subject === subject && chapters.includes(q.chapter)
      );

      shuffle(pool);
      questions = pool.slice(0, 15);

      showQuestion();
    });

  function showQuestion() {
    const q = questions[index];

    document.getElementById("progress").textContent =
      `第${index+1}問 / 全${questions.length}問`;

    document.getElementById("questionText").textContent = q.question;

    document.getElementById("judgeText").style.display = "none";

    const optDiv = document.getElementById("options");
    optDiv.innerHTML = "";

    q.options.forEach((opt,i)=>{
      const btn=document.createElement("button");
      btn.className="option";
      btn.textContent=opt;
      btn.onclick=()=>checkAnswer(i);
      optDiv.appendChild(btn);
    });

    document.getElementById("explanation").style.display="none";
    document.getElementById("nextBtn").style.display="none";
  }

  function checkAnswer(i){
    const q = questions[index];
    const btns = document.querySelectorAll(".option");

    btns.forEach((btn,idx)=>{
      btn.disabled = true;
      if(idx === q.correctIndex) btn.classList.add("correct");
      if(idx === i && idx !== q.correctIndex) btn.classList.add("wrong");
    });

    const judge = document.getElementById("judgeText");

    if(i === q.correctIndex){
      correct++;
      judge.textContent = "正解！";
      judge.className = "correctText";
    } else {
      judge.textContent = "不正解…";
      judge.className = "wrongText";
    }

    judge.style.display = "block";

    const exp=document.getElementById("explanation");
    exp.innerHTML=q.explanation;
    exp.style.display="block";

    document.getElementById("nextBtn").style.display="block";
  }

  function nextQuestion(){
    index++;
    if(index>=questions.length){
      showResult();
      return;
    }
    showQuestion();
  }

  function showResult(){
    document.getElementById("quizScreen").style.display="none";
    const resultScreen = document.getElementById("resultScreen");
    resultScreen.style.display="block";

    const rate = Math.round((correct/questions.length)*100);
    document.getElementById("scoreText").textContent =
      `正解数：${correct} / ${questions.length}（正答率：${rate}%）`;

    const oldImg = document.getElementById("perfectImg");
    if (oldImg) oldImg.remove();

    const oldMsg = document.getElementById("perfectMsg");
    if (oldMsg) oldMsg.remove();

    resultScreen.style.background = "white";

    if(rate === 100){

      resultScreen.style.background = "#fff8d6";

      const perfectImages = [
        "ushiro_harimijikai_gray_ikume_.png",
        "01harimijikai_grau_ikume.png",
        "陸上イクメちゃん.png",
        "帽子なし野球ユニフォーム.png"
      ];
      const randomImg = perfectImages[Math.floor(Math.random() * perfectImages.length)];

      const img = document.createElement("img");
      img.id = "perfectImg";
      img.src = randomImg;
      img.style.width = "100%";
      img.style.maxWidth = "260px";
      img.style.display = "block";
      img.style.margin = "0 auto 1rem auto";
      resultScreen.insertBefore(img, resultScreen.firstChild);

      const msg = document.createElement("div");
      msg.id = "perfectMsg";
      msg.textContent = "Very Good!";
      msg.style.textAlign = "center";
      msg.style.fontSize = "1.4rem";
      msg.style.fontWeight = "bold";
      msg.style.color = "#d9534f";
      msg.style.marginBottom = "1rem";
      resultScreen.insertBefore(msg, document.getElementById("scoreText"));
    }
  }
</script>

</body>
</html>
